data_config:
  source:
    - alias: inc
      join_type: primary

      type: servicenow
      table: incident

      filters:
        active: "true"
        priority: ["1", "2"]

      fields:
        - sys_id
        - number
        - short_description
        - description
        - priority
        - state
        - assigned_to

      limit: 10

      order_by: sys_created_on
      order_desc: true
    - alias: ticket
      join_type: random
      primary_key: sys_id
      join_key: sys_id

      type: servicenow
      table: incident

      filters:
        active: "true"
        priority: ["1", "2"]

      fields:
        - sys_id
        - urgency
        - impact

      limit: 10

      order_by: sys_created_on
      order_desc: true

  sink:
    - alias: inc
      type: servicenow
      table: u_ai_incident_analysis
      operation: insert

  id_column: sys_id

graph_config:
  nodes:
    analyzer:
      node_type: llm
      model:
        name: gpt-5
        temperature: 0.1
        max_tokens: 1024

      input_key: input
      output_key: ai_analysis

      post_process: tasks.examples.servicenow_ai_analysis_insert.task_executor.AnalyzerPostProcessor

      prompt:
        - system: |
            You are an expert IT incident analyst. Analyze ServiceNow incidents and provide structured insights.

            Provide your analysis as a JSON object with these fields:
            - severity_score: integer from 1-10 indicating severity
            - predicted_resolution_time: estimated hours to resolve
            - recommended_action: brief action to take (max 200 chars)
            - root_cause_category: one of [technical, user, process, other]
            - confidence: your confidence in this analysis (0.0-1.0)

            Return ONLY the JSON object, no other text.
        - user: |
            Analyze this ServiceNow incident:

            - Number: {inc->number}
            - Short Description: {inc->short_description}
            - Full Description: {inc->description}
            - Priority: {inc->priority}
            - State: {inc->state}
            - Urgency: {ticket->urgency}
            - Impact: {ticket->impact}

  edges:
    - from: START
      to: analyzer
    - from: analyzer
      to: END
