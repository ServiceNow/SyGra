data_config:
  resumable: false

graph_config:
  nodes:
    pick_scenario:
      node_type: lambda
      lambda: tasks.examples.flight_booking_conversations.task_executor.PickScenario
      output_keys:
        - scenario_id
        - scenario_name
        - scenario_description
        - scenario_goal
        - scenario_outcome
        - failure_reason
        - coverage_tags
        - category
        - subcategory

    convo_attributes:
      node_type: weighted_sampler
      attributes:
        num_turns:
          values: [6, 8, 10, 12]
          weights: [3, 5, 4, 2]
        user_detail_level:
          values: [complete, partial, minimal]
          weights: [3, 6, 2]
        include_upgrade_offer:
          values: [true, false]
          weights: [5, 5]
        include_baggage:
          values: [true, false]
          weights: [4, 6]
        include_seat_meal_prefs:
          values: [true, false]
          weights: [4, 6]
        tone:
          values: [professional, friendly, casual, formal]
          weights: [5, 4, 2, 2]
        locale:
          values: [en-US, en-GB, en-IN]
          weights: [5, 2, 3]
        user_voice:
          values: [alloy, nova, shimmer, onyx, echo, fable]
          weights: [2, 3, 2, 2, 1, 1]
        assistant_voice:
          values: [alloy, nova, shimmer, onyx, echo, fable]
          weights: [3, 2, 2, 2, 1, 1]
        wrapup_style:
          values: [none, close, followup]
          weights: [7, 2, 1]

    generate_conversation:
      node_type: llm
      output_keys: raw_conversation
      prompt:
        - system: |
            You are a helpful flight booking assistant.
            You must produce a realistic multi-turn conversation between a user and an assistant about flight booking.
            Follow the scenario and constraints precisely.
            Do not claim to access real-time inventory or pricing; instead present plausible options and ask clarifying questions.

        - user: |
            Generate a conversation for the following scenario.

            Scenario:
              scenario_id: {scenario_id}
              scenario_name: {scenario_name}
              scenario_description: {scenario_description}
              goal: {scenario_goal}
              expected_outcome: {scenario_outcome}
              failure_reason_if_any: {failure_reason}
              coverage_tags: {coverage_tags}

            Conversation controls:
              locale: {locale}
              tone: {tone}
              user_detail_level: {user_detail_level}
              include_upgrade_offer: {include_upgrade_offer}
              include_baggage: {include_baggage}
              include_seat_meal_prefs: {include_seat_meal_prefs}
              num_turns: {num_turns}
              wrapup_style: {wrapup_style}

            Requirements:
              - The conversation must have exactly {num_turns} messages.
              - Messages must strictly alternate roles starting with user and ending with assistant.
              - The user should be natural and sometimes provide incomplete information depending on user_detail_level.
              - The assistant should ask concise clarifying questions when details are missing, but must converge quickly.
              - If some details remain missing late in the conversation, the assistant should propose reasonable defaults (and explicitly state them) to ensure the outcome can be reached within {num_turns} messages.
              - If include_upgrade_offer is true, the assistant must proactively ask about upgrading (e.g., premium economy / business) and explain tradeoffs.
              - If include_baggage is true, include a discussion about baggage needs.
              - If include_seat_meal_prefs is true, include seat and/or meal preferences.
              - Keep all details internally consistent (cities, dates, passenger counts, etc.).
              - The conversation must reach a clear resolution consistent with expected_outcome.
              - If wrapup_style is not "none", you must include a short wrap-up sequence at the end:
                  - The resolution MUST occur no later than the assistant message at position {num_turns}-4.
                  - The assistant message at position {num_turns}-2 MUST ask: "Is there anything else I can help you with?"
                  - If wrapup_style is "close", the user (position {num_turns}-1) should say they are done, and the assistant (final message) should politely close.
                  - If wrapup_style is "followup", the user (position {num_turns}-1) should ask a new, related question (baggage, seats, check-in, changes, refunds, loyalty, etc.), and the assistant (final message) should answer and then close.
              - If wrapup_style is "none", the final assistant message must be the resolution/closure (do not introduce new unresolved questions at the end for success).
              - If expected_outcome is "success", the resolution MUST include:
                  - confirm the booking was completed (include a realistic confirmation code / record locator)
                  - recap itinerary details and passenger count
                  - provide next steps (e.g., e-ticket/email, check-in guidance)
              - If expected_outcome is "failure", the resolution MUST include:
                  - clearly state the failure reason (use failure_reason_if_any as guidance)
                  - propose at least 2 alternatives (different dates/times, nearby airports, adding a stop, different cabin)
                  - end with a question asking which alternative the user prefers

            Output format:
              Return ONLY valid JSON in the following shape:
              {{
                "conversation": [
                  {{"role": "user", "content": "..."}},
                  {{"role": "assistant", "content": "..."}}
                ]
              }}

      model:
        name: gpt-4o-mini
        parameters:
          temperature: 1.0

    validate_conversation:
      node_type: lambda
      lambda: tasks.examples.flight_booking_conversations.task_executor.ValidateConversationResolution
      output_keys:
        - conversation_complete
        - completion_notes

    synthesize_audio:
      node_type: lambda
      lambda: tasks.examples.flight_booking_conversations.task_executor.SynthesizeConversationAudio
      user_voice: nova
      assistant_voice: alloy
      output_keys:
        - conversation_audio
        - user_voice
        - assistant_voice

  edges:
    - from: START
      to: pick_scenario
    - from: pick_scenario
      to: convo_attributes
    - from: convo_attributes
      to: generate_conversation
    - from: generate_conversation
      to: validate_conversation
    - from: validate_conversation
      to: synthesize_audio
    - from: synthesize_audio
      to: END

output_config:
  generator: tasks.examples.flight_booking_conversations.task_executor.FlightBookingOutputGenerator

  output_map:
    id:
      from: id
    conversation:
      from: raw_conversation
      transform: build_conversation
    conversation_audio:
      from: conversation_audio
    taxonomy:
      from: scenario_id
      transform: build_taxonomy
    metadata:
      from: scenario_id
      transform: build_metadata
